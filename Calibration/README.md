# 显示器逐像素点校准矩阵训练器

这个项目实现了一个完整的显示器逐像素点校准系统，可以训练出校准矩阵来优化显示器的颜色准确性和均匀性。

## 功能特性

- **自动框架检测**: 支持PyTorch CUDA/MPS和CPU NumPy计算（Windows系统兼容）
- **逐像素校准**: 为每个像素点生成独立的3×3校准变换矩阵
- **多重损失函数**: 包含亮度差损失、颜色纯度损失和高亮度惩罚
- **全局优化**: 最小化极差、相邻像素差异和目标亮度偏差
- **详细评估**: 生成完整的校准效果分析报告

## 损失函数设计

### 每像素损失函数
1. **亮度差损失**: `σ(各通道亮度值 - 220)²` - 最小化与目标亮度的差异
2. **颜色纯度损失**: `log(R-B × R-G × G-R × G-B × B-R × B-G)` - 惩罚不纯的颜色
3. **高亮度惩罚**: `log(R×G×B / 256³)` - 对高亮度的差异惩罚减少

### 全局损失函数
1. **极差最小化**: 减少显示区域内的亮度范围
2. **相邻像素平滑**: 最小化相邻像素点的亮度差异
3. **目标亮度校正**: 确保整体均值接近目标亮度220

## 安装要求

```bash
pip install -r requirements.txt
```

### 支持的计算框架
- **PyTorch**: 支持CUDA和MPS GPU加速（推荐）
- **NumPy**: CPU计算的后备选项

## 使用方法

### 基本使用
```bash
python train_calibration.py
```

### 高级参数
```bash
python train_calibration.py \
    --data_dir 数据集 \
    --epochs 2000 \
    --learning_rate 0.005 \
    --target_brightness 220.0
```

### 参数说明
- `--data_dir`: 数据集文件夹路径 (默认: "数据集")
- `--epochs`: 训练轮数 (默认: 1000)
- `--learning_rate`: 学习率 (默认: 0.01)
- `--target_brightness`: 目标亮度值 (默认: 220.0)

## 数据格式

数据集文件夹应包含9个CSV文件：
```
数据集/
├── R_R.csv  # 红色输出时R通道响应
├── R_G.csv  # 红色输出时G通道响应
├── R_B.csv  # 红色输出时B通道响应
├── G_R.csv  # 绿色输出时R通道响应
├── G_G.csv  # 绿色输出时G通道响应
├── G_B.csv  # 绿色输出时B通道响应
├── B_R.csv  # 蓝色输出时R通道响应
├── B_G.csv  # 蓝色输出时G通道响应
└── B_B.csv  # 蓝色输出时B通道响应
```

每个文件为64×64的像素矩阵，记录在目标亮度220下的实际输出值。

## 输出文件

训练完成后会生成以下文件：

### 校准矩阵
- `calibration.csv`: 完整的校准矩阵，可用于实际显示器校准

### 校准后输出
- `calibrated_R_R.csv`, `calibrated_R_G.csv`, `calibrated_R_B.csv`
- `calibrated_G_R.csv`, `calibrated_G_G.csv`, `calibrated_G_B.csv`
- `calibrated_B_R.csv`, `calibrated_B_G.csv`, `calibrated_B_B.csv`

### 评估报告
- `calibration_evaluation.txt`: 详细的校准效果分析

## 校准方案优化建议

### 已实现的优化
1. **逐像素精细校准**: 每个像素独立的变换矩阵
2. **多目标优化**: 平衡亮度准确性、颜色纯度和显示均匀性
3. **自适应损失权重**: 不同损失项的合理权重分配
4. **相邻像素约束**: 保证显示的空间连续性

### 进一步优化方案
1. **更高分辨率校准**: 支持更大尺寸的显示器矩阵
2. **温度补偿机制**: 根据显示器温度调整校准参数
3. **动态校准**: 根据环境光线自动调整
4. **多点测量**: 增加更多测量点提高精度
5. **时间衰减补偿**: 考虑显示器老化的影响
6. **观察角度校正**: 针对不同视角的校准优化
7. **频谱响应校准**: 考虑LED背光的频谱特性
8. **用户偏好学习**: 根据用户视觉偏好微调

### 硬件集成建议
1. **实时校准**: 集成到显示器固件中
2. **传感器反馈**: 使用色度计进行闭环校准
3. **多显示器同步**: 多屏幕环境的一致性保证
4. **GPU加速**: 在显示驱动中实现实时校准

## 性能优化

- **NVIDIA GPU**: 自动检测CUDA并使用GPU加速
- **Apple GPU**: 在M系列芯片上使用MPS加速（Mac系统）
- **多核CPU**: NumPy自动利用多核处理

## 故障排除

### 常见问题
1. **内存不足**: 减少批次大小或使用更小的校准矩阵
2. **收敛缓慢**: 调整学习率或增加训练轮数
3. **过度拟合**: 增加正则化权重或减少模型复杂度

### 性能调优
- 使用较小的学习率获得更稳定的收敛
- 增加训练轮数以获得更好的校准效果
- 根据显示器特性调整损失函数权重

## 许可证

本项目使用MIT许可证。 